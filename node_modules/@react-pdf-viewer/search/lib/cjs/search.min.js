"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@react-pdf-viewer/core");function t(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var r=t(require("react")),n=function(){return r.createElement(e.Icon,{size:16},r.createElement("path",{d:"M0.541,5.627L11.666,18.2c0.183,0.207,0.499,0.226,0.706,0.043c0.015-0.014,0.03-0.028,0.043-0.043\n            L23.541,5.627"}))},o=function(){return r.createElement(e.Icon,{size:16},r.createElement("path",{d:"M23.535,18.373L12.409,5.8c-0.183-0.207-0.499-0.226-0.706-0.043C11.688,5.77,11.674,5.785,11.66,5.8\n            L0.535,18.373"}))},a=function(){return r.createElement(e.Icon,{ignoreDirection:!0,size:16},r.createElement("path",{d:"M10.5,0.5c5.523,0,10,4.477,10,10s-4.477,10-10,10s-10-4.477-10-10S4.977,0.5,10.5,0.5z\n            M23.5,23.5\n            l-5.929-5.929"}))},c=function(){return c=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},c.apply(this,arguments)},u={keyword:"",regExp:new RegExp(" "),wholeWords:!1},s=function(e){var t,r=e.wholeWords?" ".concat(e.keyword," "):e.keyword,n=e.matchCase?"g":"gi";return{keyword:e.keyword,regExp:new RegExp((t=r,t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")),n),wholeWords:e.wholeWords||!1}},i=function(e,t,r){return e instanceof RegExp?{keyword:e.source,regExp:e,wholeWords:r||!1}:"string"==typeof e?""===e?u:s({keyword:e,matchCase:t||!1,wholeWords:r||!1}):(void 0!==t&&(e.matchCase=t),void 0!==r&&(e.wholeWords=r),s(e))},l=function(t){var n,o=function(e){var t=r.useRef(e.get("doc")),n=function(e){t.current=e};return r.useEffect((function(){return e.subscribe("doc",n),function(){e.unsubscribe("doc",n)}}),[]),t}(t),a=r.useState([]),c=a[0],s=a[1],l=r.useState([]),h=l[0],f=l[1],d=r.useState(0),p=d[0],g=d[1],m=r.useState(!1),v=m[0],x=m[1],y=r.useRef([]),E=r.useState(!1),b=E[0],w=E[1],S=function(){return!0},k=r.useCallback((function(){return t.get("targetPageFilter")||S}),[t.get("targetPageFilter")]),P=function(e){var t=h.length;if(0===c.length||0===t)return null;var r=e===t+1?1:Math.max(1,Math.min(t,e));return g(r),C(h[r-1])},_=function(e){return s(""===e?[]:[e])},C=function(e){var r=t.get("jumpToPage");return r&&r(e.pageIndex),t.update("matchPosition",{matchIndex:e.matchIndex,pageIndex:e.pageIndex}),e},I=function(r,n,a){var c=o.current;if(!c)return Promise.resolve([]);var u=c.numPages,s=r.map((function(e){return i(e,n,a)}));return t.update("keyword",s),g(0),f([]),new Promise((function(t,r){var n=0===y.current.length?function(){var t=o.current;if(!t)return Promise.resolve([]);var r=Array(t.numPages).fill(0).map((function(r,n){return e.getPage(t,n).then((function(e){return e.getTextContent()})).then((function(e){var t=e.items.map((function(e){return e.str||""})).join("");return Promise.resolve({pageContent:t,pageIndex:n})}))}));return Promise.all(r).then((function(e){return e.sort((function(e,t){return e.pageIndex-t.pageIndex})),Promise.resolve(e.map((function(e){return e.pageContent})))}))}().then((function(e){return y.current=e,Promise.resolve(e)})):Promise.resolve(y.current);n.then((function(e){var r=[];e.forEach((function(e,t){k()({pageIndex:t,numPages:u})&&s.forEach((function(n){for(var o,a=0;null!==(o=n.regExp.exec(e));)r.push({keyword:n.regExp,matchIndex:a,pageIndex:t,pageText:e,startIndex:o.index,endIndex:n.regExp.lastIndex}),a++}))})),f(r),r.length>0&&(g(1),C(r[0])),t(r)}))}))};return r.useEffect((function(){y.current=[]}),[o.current]),{clearKeyword:function(){t.update("keyword",[u]),_(""),g(0),f([]),x(!1),w(!1)},changeMatchCase:function(e){x(e),c.length>0&&I(c,e,b)},changeWholeWords:function(e){w(e),c.length>0&&I(c,v,e)},currentMatch:p,jumpToMatch:P,jumpToNextMatch:function(){return P(p+1)},jumpToPreviousMatch:function(){return P(p-1)},keywords:c,matchCase:v,numberOfMatches:h.length,wholeWords:b,search:function(){return I(c,v,b)},searchFor:I,setKeywords:s,keyword:0===c.length?"":(n=c[0],n instanceof RegExp?n.source:"string"==typeof n?n:n.keyword),setKeyword:_,setTargetPages:function(e){t.update("targetPageFilter",e)}}},h=function(e){var t=e.children,r=e.store,n=l(r);return t(c({},n))},f=function(t){var n=t.containerRef,o=t.store,a=r.useState(!0),c=a[0],u=a[1],s=function(){return u(!0)},i=function(){return u(!1)},l=function(t){var r=n.current;r&&(t.shiftKey||t.altKey||"f"!==t.key||(e.isMac()?t.metaKey&&!t.ctrlKey:t.ctrlKey)&&(c||document.activeElement&&r.contains(document.activeElement))&&(t.preventDefault(),o.update("areShortcutsPressed",!0)))};return r.useEffect((function(){var e=n.current;if(e)return document.addEventListener("keydown",l),e.addEventListener("mouseenter",s),e.addEventListener("mouseleave",i),function(){document.removeEventListener("keydown",l),e.removeEventListener("mouseenter",s),e.removeEventListener("mouseleave",i)}}),[n.current]),r.createElement(r.Fragment,null)},d={left:0,top:8},p=function(t){var a=t.store,c=t.onToggle,u=r.useContext(e.LocalizationContext).l10n,s=r.useContext(e.ThemeContext).direction,i=r.useState(!1),h=i[0],f=i[1],p=r.useState(!1),g=p[0],m=p[1],v=s===e.TextDirection.RightToLeft,x=l(a),y=x.clearKeyword,E=x.changeMatchCase,b=x.changeWholeWords,w=x.currentMatch,S=x.jumpToNextMatch,k=x.jumpToPreviousMatch,P=x.keyword,_=x.matchCase,C=x.numberOfMatches,I=x.wholeWords,T=x.search,M=x.setKeyword,L=u&&u.search?u.search.enterToSearch:"Enter to search",R=u&&u.search?u.search.previousMatch:"Previous match",j=u&&u.search?u.search.nextMatch:"Next match";return r.createElement("div",{className:"rpv-search__popover"},r.createElement("div",{className:"rpv-search__popover-input-counter"},r.createElement(e.TextBox,{ariaLabel:L,autoFocus:!0,placeholder:L,type:"text",value:P,onChange:function(e){m(!1),M(e)},onKeyDown:function(e){"Enter"===e.key&&P&&(g?S():(f(!0),T().then((function(e){f(!1),m(!0)}))))}}),r.createElement("div",{className:e.classNames({"rpv-search__popover-counter":!0,"rpv-search__popover-counter--ltr":!v,"rpv-search__popover-counter--rtl":v})},h&&r.createElement(e.Spinner,{testId:"search__popover-searching",size:"1rem"}),!h&&r.createElement("span",{"data-testid":"search__popover-num-matches"},w,"/",C))),r.createElement("label",{className:"rpv-search__popover-label"},r.createElement("input",{className:"rpv-search__popover-label-checkbox",checked:_,type:"checkbox",onChange:function(e){m(!1),E(e.target.checked)}})," ",u&&u.search?u.search.matchCase:"Match case"),r.createElement("label",{className:"rpv-search__popover-label"},r.createElement("input",{className:"rpv-search__popover-label-checkbox",checked:I,type:"checkbox",onChange:function(e){m(!1),b(e.target.checked)}})," ",u&&u.search?u.search.wholeWords:"Whole words"),r.createElement("div",{className:"rpv-search__popover-footer"},r.createElement("div",{className:"rpv-search__popover-footer-item"},r.createElement(e.Tooltip,{ariaControlsSuffix:"search-previous-match",position:v?e.Position.BottomRight:e.Position.BottomCenter,target:r.createElement(e.MinimalButton,{ariaLabel:R,isDisabled:w<=1,onClick:k},r.createElement(o,null)),content:function(){return R},offset:d})),r.createElement("div",{className:"rpv-search__popover-footer-item"},r.createElement(e.Tooltip,{ariaControlsSuffix:"search-next-match",position:e.Position.BottomCenter,target:r.createElement(e.MinimalButton,{ariaLabel:j,isDisabled:w>C-1,onClick:S},r.createElement(n,null)),content:function(){return j},offset:d})),r.createElement("div",{className:e.classNames({"rpv-search__popover-footer-button":!0,"rpv-search__popover-footer-button--ltr":!v,"rpv-search__popover-footer-button--rtl":v})},r.createElement(e.Button,{onClick:function(){c(),y()}},u&&u.search?u.search.close:"Close"))))},g=function(t){var n=t.children,o=t.onClick,c=r.useContext(e.LocalizationContext).l10n,u=c&&c.search?c.search.search:"Search";return n({icon:r.createElement(a,null),label:u,onClick:o})},m={left:0,top:8},v=function(t){var n=t.enableShortcuts,o=t.store,a=t.onClick,c=n?e.isMac()?"Meta+F":"Ctrl+F":"",u=function(e){e&&a()};return r.useEffect((function(){return o.subscribe("areShortcutsPressed",u),function(){o.unsubscribe("areShortcutsPressed",u)}}),[]),r.createElement(g,{onClick:a},(function(t){return r.createElement(e.Tooltip,{ariaControlsSuffix:"search-popover",position:e.Position.BottomCenter,target:r.createElement(e.MinimalButton,{ariaKeyShortcuts:c,ariaLabel:t.label,testId:"search__popover-button",onClick:a},t.icon),content:function(){return t.label},offset:m})}))},x={left:0,top:8},y=function(t){var n=t.children,o=t.enableShortcuts,a=t.store,u=r.useContext(e.ThemeContext).direction===e.TextDirection.RightToLeft?e.Position.BottomRight:e.Position.BottomLeft,s=n||function(e){return r.createElement(v,c({enableShortcuts:o,store:a},e))};return r.createElement(e.Popover,{ariaControlsSuffix:"search",lockScroll:!1,position:u,target:function(e){return s({onClick:e})},content:function(e){return r.createElement(p,{store:a,onToggle:e})},offset:x,closeOnClickOutside:!1,closeOnEscape:!0})},E=function(e){var t=e.parentNode;t&&t.removeChild(e)},b=function(e){var t=e.parentNode;if(t){var r=document.createRange();r.selectNodeContents(e),function(e,t){E(e);var r=t.parentNode;r&&r.insertBefore(e,t),E(t)}(r.extractContents(),e),t.normalize()}},w=function(e){return parseFloat(e.slice(0,-1))},S=function(e,t){var r=w(e.style.top),n=w(e.style.left),o=w(t.style.top),a=w(t.style.left);return r<o?-1:r>o?1:n<a?-1:n>a?1:0},k=function(t){var n=t.numPages,o=t.pageIndex,a=t.store,c=t.onHighlightKeyword,s=r.useState(a.get("matchPosition")),i=s[0],l=s[1],h=r.useState(a.get("keyword")||[u]),f=h[0],d=h[1],p=r.useState({pageIndex:o,scale:1,status:e.LayerRenderStatus.PreRender}),g=p[0],m=p[1],v=r.useRef(null),x=r.useRef([]),y=function(){return!0},E=r.useCallback((function(){return a.get("targetPageFilter")||y}),[a.get("targetPageFilter")]),w=function(e){for(var t=e.querySelectorAll("span.rpv-search__highlight"),r=t.length,n=0;n<r;n++)t[n].parentElement.removeChild(t[n])},k=function(e){var t=x.current;if(0!==t.length){var r=[].slice.call(e.querySelectorAll(".rpv-core__text-layer-text")),n=t.map((function(e){return e.char})).join("");f.forEach((function(o){var a=o.keyword;if(a.trim()){for(var u,s=-1===o.regExp.flags.indexOf("g")?new RegExp(o.regExp,"".concat(o.regExp.flags,"g")):o.regExp,i=[];null!==(u=s.exec(n));)i.push({keyword:s,startIndex:u.index,endIndex:s.lastIndex});i.map((function(e){return{keyword:e.keyword,indexes:t.slice(e.startIndex,e.endIndex)}})).forEach((function(t){var n=t.indexes.reduce((function(e,t){return e[t.spanIndex]=(e[t.spanIndex]||[]).concat([t]),e}),{});Object.values(n).forEach((function(n){if(1!==n.length||""!==n[0].char.trim()){var u=o.wholeWords?n.slice(1,-1):n;!function(e,t,r,n,o){var a=document.createRange(),u=n.firstChild;if(u){var s=o[0].charIndexInSpan,i=1===o.length?s:o[o.length-1].charIndexInSpan;a.setStart(u,s),a.setEnd(u,i+1);var l=document.createElement("span");a.surroundContents(l);var h=l.getBoundingClientRect(),f=r.getBoundingClientRect(),d=document.createElement("span");r.insertBefore(d,r.firstChild),d.style.left="".concat(100*(h.left-f.left)/f.width,"%"),d.style.top="".concat(100*(h.top-f.top)/f.height,"%"),d.style.width="".concat(100*h.width/f.width,"%"),d.style.height="".concat(100*h.height/f.height,"%"),d.classList.add("rpv-search__highlight"),d.setAttribute("title",e.trim()),b(l),c&&c({highlightEle:d,keyword:t})}}(a,t.keyword,e,r[u[0].spanIndex],u)}}))}))}})),[].slice.call(e.querySelectorAll(".rpv-search__highlight")).sort(S).forEach((function(e,t){e.setAttribute("data-index","".concat(t))}))}},P=function(e){e&&e.length>0&&d(e)},_=function(e){return l(e)},C=function(e){if(e.has(o)){var t=e.get(o);t&&m({ele:t.ele,pageIndex:o,scale:t.scale,status:t.status})}},I=function(){return 0===f.length||1===f.length&&""===f[0].keyword.trim()};r.useEffect((function(){if(!I()&&g.status===e.LayerRenderStatus.DidRender&&!x.current.length){var t=g.ele,r=[].slice.call(t.querySelectorAll(".rpv-core__text-layer-text")).map((function(e){return e.textContent})).reduce((function(e,t,r){return e.concat(t.split("").map((function(e,t){return{char:e,charIndexInSpan:t,spanIndex:r}})))}),[{char:"",charIndexInSpan:0,spanIndex:0}]).slice(1);x.current=r}}),[f,g.status]),r.useEffect((function(){if(!I()&&g.ele&&g.status===e.LayerRenderStatus.DidRender&&E()({pageIndex:o,numPages:n})){var t=g.ele;w(t),k(t),T()}}),[f,i,g.status,x.current]),r.useEffect((function(){I()&&g.ele&&g.status===e.LayerRenderStatus.DidRender&&w(g.ele)}),[f,g.status]);var T=function(){if(i.pageIndex===o&&g.ele&&g.status===e.LayerRenderStatus.DidRender){var t=g.ele,r=t.querySelector('.rpv-search__highlight[data-index="'.concat(i.matchIndex,'"]'));if(r){var n=function(e,t){for(var r=e.offsetTop,n=e.offsetLeft,o=e.parentElement;o&&o!==t;)r+=o.offsetTop,n+=o.offsetLeft,o=o.parentElement;return{left:n,top:r}}(r,t),c=n.left,u=n.top,s=a.get("jumpToDestination");s&&(s(o,(t.getBoundingClientRect().height-u)/g.scale,c/g.scale,g.scale),v.current&&v.current.classList.remove("rpv-search__highlight--current"),v.current=r,r.classList.add("rpv-search__highlight--current"))}}};return r.useEffect((function(){return a.subscribe("keyword",P),a.subscribe("matchPosition",_),a.subscribe("renderStatus",C),function(){a.unsubscribe("keyword",P),a.unsubscribe("matchPosition",_),a.unsubscribe("renderStatus",C)}}),[]),r.createElement(r.Fragment,null)},P=function(e){return Array.isArray(e)?e.map((function(e){return i(e)})):[i(e)]};exports.NextIcon=n,exports.PreviousIcon=o,exports.SearchIcon=a,exports.searchPlugin=function(t){var n=r.useMemo((function(){return Object.assign({},{enableShortcuts:!0,onHighlightKeyword:function(){}},t)}),[]),o=r.useMemo((function(){return e.createStore({matchPosition:{matchIndex:-1,pageIndex:-1},renderStatus:new Map,keyword:t&&t.keyword?P(t.keyword):[u]})}),[]),a=l(o),s=a.clearKeyword,i=a.jumpToMatch,d=a.jumpToNextMatch,p=a.jumpToPreviousMatch,g=a.searchFor,m=a.setKeywords,x=a.setTargetPages,E=function(e){return r.createElement(y,c({enableShortcuts:n.enableShortcuts},e,{store:o}))};return{install:function(e){var r=t&&t.keyword?P(t.keyword):[u];o.update("jumpToDestination",e.jumpToDestination),o.update("jumpToPage",e.jumpToPage),o.update("keyword",r)},renderPageLayer:function(e){return r.createElement(k,{key:e.pageIndex,numPages:e.doc.numPages,pageIndex:e.pageIndex,store:o,onHighlightKeyword:n.onHighlightKeyword})},renderViewer:function(e){var t=e.slot;return t.subSlot&&(t.subSlot.children=r.createElement(r.Fragment,null,n.enableShortcuts&&r.createElement(f,{containerRef:e.containerRef,store:o}),t.subSlot.children)),t},uninstall:function(e){var t=o.get("renderStatus");t&&t.clear()},onDocumentLoad:function(e){o.update("doc",e.doc)},onTextLayerRender:function(e){var t=o.get("renderStatus");t&&(t=t.set(e.pageIndex,e),o.update("renderStatus",t))},Search:function(e){return r.createElement(h,c({},e,{store:o}))},ShowSearchPopover:E,ShowSearchPopoverButton:function(){return r.createElement(E,null,(function(e){return r.createElement(v,c({enableShortcuts:n.enableShortcuts,store:o},e))}))},clearHighlights:function(){s()},highlight:function(e){var t=Array.isArray(e)?e:[e];return m(t),g(t)},jumpToMatch:i,jumpToNextMatch:d,jumpToPreviousMatch:p,setTargetPages:x}};
